// src/components/progress/_styles.scss
@use '../../styles/abstract/base' as base;
@use '../../styles/abstract/variables' as v;
@use '../../styles/abstract/functions' as f;
@use '../../styles/abstract/mixins' as m;
@use '../../styles/abstract/theme' as t;
@use 'sass:math';

$component: '#{base.$prefix}-progress';

// Material Design 3 spec constants
$linear-height: 4px;
$circular-size: 48px;
$stroke-width: 6px;

.#{$component} {
  // Base styles
  position: relative;
  display: block;
  overflow: hidden;
  
  // Common accessibility attributes
  &[aria-disabled="true"] {
    opacity: 0.38;
    pointer-events: none;
  }
  
  // Linear progress variant - MD3 specs
  &--linear {
    width: 100%;
    height: $linear-height; // MD3 spec height
    border-radius: calc($linear-height / 2);
    
    // Track - the "remaining" part (lighter color)
    .#{$component}-track {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      // background-color: t.color('surface-container-highest');
      border-radius: calc($linear-height / 2);
      z-index: 0; // Lowest layer
    }
    
    // Buffer element for "buffering" scenarios (video loading, etc.)
    .#{$component}-buffer {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0;
      background-color: t.alpha('primary', 0.4);
      transition: width 0.3s ease;
      border-radius: calc($linear-height / 2);
    }
    
    // Indicator - the "active" part (primary color)
    .#{$component}-indicator {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0;
      background-color: t.color('primary');
      transition: width 0.3s ease;
      border-radius: calc($linear-height / 2);
      z-index: 2; // Higher than remaining and track
      // animation: 
      //   linear-indeterminate-translate 2.5s infinite linear,
      //   linear-indeterminate-width 2.5s infinite ease-in-out;
    }
    
    // Remaining - the space between indicator and 100%
    .#{$component}-remaining {
      position: absolute;
      top: 0;
      height: 100%;
      // Left and width are set programmatically
      background-color: t.alpha('primary', 0.24);
      border-radius: calc($linear-height / 2);
      transition: left 0.3s ease, width 0.3s ease, margin-left 0.3s ease;
      z-index: 1; // Lower than indicator but higher than track
      box-sizing: border-box; // Ensure consistent sizing
      // display: none; // We're only using a single segment
    }
    
    // Indeterminate animation for linear progress
    &.#{$component}--indeterminate {
      .#{$component}-buffer {
        display: none;
      }
      
      .#{$component}-indicator {
        width: 0; // Initial width
        animation: 
          linear-indeterminate-translate 1.7s infinite linear,
          linear-indeterminate-width 1.7s infinite ease-in-out;
        border-radius: calc($linear-height / 2);
        z-index: 2;
      }
      
      .#{$component}-remaining {
        display: block;
        width: 100%;
      }
    }
    
    // Label element
    .#{$component}-label {
      position: absolute;
      right: 0;
      top: calc($linear-height + 4px); // Position below the progress bar
      font-size: 12px;
      color: t.color('on-surface-variant');
    }
  }
  
  // Circular progress variant - MD3 specs
  &--circular {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: $circular-size;
    height: $circular-size;
    svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
      transform-origin: center;
    }
    
    // Track - the "remaining" part (lighter color)
    .#{$component}-track {
      stroke: t.color('surface-container-highest');
      fill: none;
      stroke-width: $stroke-width;
    }
    
    // Indicator - the "active" part (primary color)
    .#{$component}-indicator {
      stroke: t.color('primary');
      fill: none;
      stroke-width: $stroke-width;
      stroke-dasharray: 283; // 2*PI*45
      stroke-dashoffset: 283;
      transition: stroke-dashoffset 0.3s ease;
      stroke-linecap: round;
      transform-origin: center;
      // MD3 adds a 4px gap between the indicator and track
      // This is handled in the SVG circle radius
    }
    
    // Remaining - the space between indicator and track
    .#{$component}-remaining {
      stroke: t.alpha('primary', 0.24);
      fill: none;
      stroke-width: $stroke-width;
      stroke-linecap: round;
      transform-origin: center;
      // Dash array and offset will be managed with JS
    }
    
    // Indeterminate animation for circular progress
    &.#{$component}--indeterminate {
      svg {
        // Add a rotation to the svg to create a spinning effect
        animation: circular-rotate 2s linear infinite;
      }
      
      .#{$component}-remaining {
        display: none;
      }
      
      .#{$component}-indicator {
        // Modify this animation to not include rotation, just the stroke dash
        animation: circular-dash 1.5s ease-in-out infinite;
        stroke-dasharray: 80, 200;
        stroke-dashoffset: 0;
      }
    }
    
    // Label element
    .#{$component}-label {
      position: absolute;
      font-size: 12px;
      color: t.color('on-surface-variant');
      text-align: center;
    }
  }
  
  // Disabled state
  &--disabled {
    opacity: 0.38;
    pointer-events: none;
  }
}

// Keyframes for indeterminate animations
@keyframes linear-indeterminate {
  0% {
    left: -40%;
  }
  100% {
    left: 100%;
  }
}

// Split the circular animation into two parts
@keyframes circular-rotate {
  0% {
    transform: rotate(-90deg);
  }
  100% {
    transform: rotate(270deg); // Full rotation
  }
}

@keyframes circular-dash {
  0% {
    stroke-dasharray: 1, 200;
    stroke-dashoffset: 0;
  }
  50% {
    stroke-dasharray: 100, 200;
    stroke-dashoffset: -15;
  }
  100% {
    stroke-dasharray: 100, 200;
    stroke-dashoffset: -125;
  }
}

@keyframes linear-indeterminate-translate {
  0% {
    left: -12%; 
  }
  100% {
    left: 112%;
  }
}

@keyframes linear-indeterminate-width {
  0% {
    width: 12%;
  }
  30% {
    width: 33%;
  }
  100% {
    width: 12%;
  }
}