// src/components/progress/_styles.scss
@use '../../styles/abstract/base' as base;
@use '../../styles/abstract/variables' as v;
@use '../../styles/abstract/functions' as f;
@use '../../styles/abstract/mixins' as m;
@use '../../styles/abstract/theme' as t;
@use 'sass:math';

$component: '#{base.$prefix}-progress';

// Material Design 3 spec constants
$linear-height: 4px;
$circular-size: 48px;
$stroke-width: 6px;

// Keyframes for SVG-based indeterminate linear progress
@keyframes indeterminate-bar {
  0% {
    x2: 0; 
    transform: translateX(-12%);
    stroke-width: $linear-height;
  }
  50% {
    x2: 33;
    stroke-width: $linear-height;
  }
  100% {
    x2: 12;
    transform: translateX(112%);
    stroke-width: $linear-height;
  }
}

.#{$component} {
  // Base styles
  position: relative;
  display: block;
  overflow: hidden;
  
  // Common accessibility attributes
  &[aria-disabled="true"] {
    opacity: 0.38;
    pointer-events: none;
  }
  
  &--linear {
    width: 100px !important
  }

  // Linear progress variant - MD3 specs
  &--linear {
    width: 100%;
    height: $linear-height; // MD3 spec height
    min-height: $linear-height; // Ensure minimum height
    border-radius: calc($linear-height / 2);
    
    // For SVG-based linear progress
    svg {
      overflow: visible; // Allow portions to extend outside container if needed
      width: 100%;
      height: $linear-height; // Match the container height
      min-height: $linear-height; // Ensure minimum height
      display: block; // Prevent any inline display issues
      
      line, .#{$component}-track, .#{$component}-buffer, .#{$component}-indicator, .#{$component}-remaining {
        // Ensure all line elements have the proper height
        stroke-width: $linear-height;
        // Force visibility
        vector-effect: non-scaling-stroke;
      }
      
      .#{$component}-track {
        stroke: t.color('surface-container-highest');
        stroke-width: $linear-height;
        stroke-linecap: round;
      }
      
      .#{$component}-buffer {
        stroke: t.alpha('primary', 0.4);
        stroke-width: $linear-height;
        stroke-linecap: round;
        transition: all 0.3s ease;
      }
      
      .#{$component}-indicator {
        stroke: t.color('primary');
        stroke-width: $linear-height;
        stroke-linecap: round;
        transition: all 0.3s ease;
      }
      
      .#{$component}-remaining {
        stroke: t.alpha('primary', 0.24);
        stroke-width: $linear-height;
        stroke-linecap: round;
        transition: all 0.3s ease;
      }
    }
    
    // Legacy non-SVG styling for backwards compatibility
    // Track - the "remaining" part (lighter color)
    .#{$component}-track:not(line) {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: t.color('surface-container-highest');
      border-radius: calc($linear-height / 2);
      z-index: 0; // Lowest layer
    }
    
    // Buffer element for "buffering" scenarios (video loading, etc.)
    .#{$component}-buffer:not(line) {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0;
      background-color: t.alpha('primary', 0.4);
      transition: width 0.3s ease;
      border-radius: calc($linear-height / 2);
    }
    
    // Indicator - the "active" part (primary color)
    .#{$component}-indicator:not(line) {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0;
      background-color: t.color('primary');
      transition: width 0.3s ease;
      border-radius: calc($linear-height / 2);
      z-index: 2; // Higher than remaining and track
    }
    
    // Remaining - the space between indicator and 100%
    .#{$component}-remaining:not(line) {
      position: absolute;
      top: 0;
      height: 100%;
      // Left and width are set programmatically
      background-color: t.alpha('primary', 0.24);
      border-radius: calc($linear-height / 2);
      transition: left 0.3s ease, width 0.3s ease, margin-left 0.3s ease;
      z-index: 1; // Lower than indicator but higher than track
      box-sizing: border-box; // Ensure consistent sizing
    }
    
    // Indeterminate animation for linear progress
    &.#{$component}--indeterminate {
      .#{$component}-buffer, .#{$component}-buffer:not(line) {
        display: none;
      }
      
      // For SVG elements
      svg {
        .#{$component}-indicator {
          // Use the same style of animation as the div-based version
          // but adapted for SVG elements
          transform-origin: left center;
          stroke-dasharray: none;
          stroke-dashoffset: 0;
          x1: 0;
          stroke-width: $linear-height !important; // Force stroke width
          animation: indeterminate-bar 1.7s infinite ease-in-out;
        }
        
        .#{$component}-remaining {
          display: none;
        }
      }
      
      // For legacy non-SVG elements
      .#{$component}-indicator:not(line) {
        width: 0; // Initial width
        animation: 
          linear-indeterminate-translate 1.7s infinite linear,
          linear-indeterminate-width 1.7s infinite ease-in-out;
        border-radius: calc($linear-height / 2);
        z-index: 2;
      }
      
      .#{$component}-remaining:not(line) {
        display: block;
        width: 100%;
      }
    }
    
    // Label element
    .#{$component}-label {
      position: absolute;
      right: 0;
      top: calc($linear-height + 4px); // Position below the progress bar
      font-size: 12px;
      color: t.color('on-surface-variant');
    }
  }

  // Circular progress variant
  &--circular {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    
    svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }
    
    .#{$component}-track {
      stroke: t.color('surface-container-highest');
      fill: none;
    }
    
    .#{$component}-indicator {
      stroke: t.color('primary');
      fill: none;
      stroke-dasharray: 283; // 2*PI*45
      transition: stroke-dashoffset 0.3s ease;
      stroke-linecap: round;
      transform-origin: center;
    }
    
    // Indeterminate animation for circular progress
    &.#{$component}--indeterminate {
      .#{$component}-indicator {
        animation: circular-indeterminate 1.5s linear infinite;
      }
    }
    
    .#{$component}-label {
      position: absolute;
      font-size: 12px;
      color: t.color('on-surface-variant');
    }
  }
  
  // Disabled state
  &--disabled {
    opacity: 0.38;
    pointer-events: none;
  }
}

// Keyframes for indeterminate animations

@keyframes circular-indeterminate {
  0% {
    stroke-dashoffset: 283;
  }
  50% {
    stroke-dashoffset: 70;
  }
  100% {
    stroke-dashoffset: 283;
    transform: rotate(360deg);
  }
}

// For legacy non-SVG linear progress
@keyframes linear-indeterminate-translate {
  0% {
    left: -12%; 
  }
  100% {
    left: 112%;
  }
}

@keyframes linear-indeterminate-width {
  0% {
    width: 12%;
  }
  30% {
    width: 33%;
  }
  100% {
    width: 12%;
  }
}